<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DETALHADO GERAL – Dia a Dia</title>
<style>
  :root { --bg:#0e1116; --surface:#121722; --muted:#94a3b8; --txt:#e5e7eb; --accent:#ff8c1a; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
  h1{font-size:22px;margin:0 0 16px;}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;}
  .toolbar input,.toolbar select,.toolbar button{background:var(--surface);border:1px solid #1f2937;color:var(--txt);padding:8px 10px;border-radius:8px}
  .toolbar button{background:var(--accent);color:#000;border:0;font-weight:600;cursor:pointer}
  .badge{font-size:12px;color:#000;background:var(--accent);padding:4px 8px;border-radius:999px;margin-left:8px}
  .tablewrap{background:var(--surface);border:1px solid #1f2937;border-radius:12px;overflow:auto}
  table{border-collapse:collapse;width:100%;min-width:900px}
  th,td{padding:8px 10px;border-bottom:1px solid #1f2937;white-space:nowrap}
  th{position:sticky;top:0;background:#0f1520;font-weight:700}
  td.num,th.num{text-align:right}
  tr:hover td{background:#0f1520}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>DETALHADO GERAL – Dia a Dia <span id="badge" class="badge">carregando…</span></h1>

  <div class="toolbar">
    <label>De: <input type="date" id="from"></label>
    <label>Até: <input type="date" id="to"></label>
    <label>Grua: 
      <select id="grua">
        <option value="">Todas</option>
      </select>
    </label>
    <button id="btnAtualizar">Atualizar</button>
    <button id="btnCsv">Exportar CSV</button>
  </div>

  <div class="tablewrap">
    <table id="tbl">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer">
    <div id="meta"></div>
    <div id="status"></div>
  </div>
</div>

<script>
/** COLOQUE AQUI SUA URL DO WEB APP ( /exec ) **/
const API_URL = 'https://script.google.com/macros/s/AKfycbzdm0EV1ekSHJip7Jn02-1L-iKdV4aRP_MhPgCj75H9MguTlFxUF5b0OFfVowTVMxlGHg/exec';

/* ---------------- JSONP ---------------- */
function jsonp(url, params={}) {
  return new Promise((resolve,reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    params.callback = cb;
    const qs = new URLSearchParams(params).toString();
    const s = document.createElement('script');
    const timeout = setTimeout(()=>{
      cleanup(); reject(new Error('Timeout ao chamar API'));
    }, 15000);
    function cleanup(){
      clearTimeout(timeout);
      s.remove();
      try{ delete window[cb] }catch(_){}
    }
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    s.onerror = ()=>{ cleanup(); reject(new Error('Falha ao carregar API')); };
    s.src = url + '?' + qs;
    document.body.appendChild(s);
  });
}

/* ---------------- RENDER ---------------- */
const el = (id)=>document.getElementById(id);
const badge = el('badge'), thead = el('thead'), tbody = el('tbody'), statusEl = el('status'), metaEl = el('meta');

function setBadge(t){ badge.textContent = t; }
function fmt(n){ return (Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }

function render(data){
  if(!data || !data.ok){ setBadge('erro'); statusEl.textContent = data && data.error ? data.error : 'Erro'; return; }
  const {meta, rows} = data;
  setBadge(`${rows.length} gruas · ${meta.dates.length} dias`);
  statusEl.textContent = '';
  metaEl.textContent = `Período ${meta.from} → ${meta.to}`;

  // cabeça
  const cols = ['GRUA', ...meta.dates, 'TOTAL'];
  thead.innerHTML = '<tr>' + cols.map((c,i)=>`<th class="${i? 'num':''}">${c}</th>`).join('') + '</tr>';

  // corpo
  tbody.innerHTML = rows.map(r=>{
    const tds = [`<td>${r.grua}</td>`]
      .concat(r.values.map(v=>`<td class="num">${fmt(v)}</td>`))
      .concat([`<td class="num">${fmt(r.total)}</td>`]);
    return `<tr>${tds.join('')}</tr>`;
  }).join('');

  // popula combo de grua
  const gSel = el('grua');
  const current = gSel.value;
  gSel.innerHTML = '<option value="">Todas</option>' + meta.gruas
    .map(g=>`<option value="${g}">${g}</option>`).join('');
  if (current) gSel.value = current; // preserva seleção
}

/* ---------------- CSV ---------------- */
function toCsv(data){
  const {meta, rows} = data;
  const head = ['GRUA', ...meta.dates, 'TOTAL'];
  const lines = [head.join(';')];
  rows.forEach(r=>{
    lines.push([r.grua, ...r.values.map(v=>fmt(v)), fmt(r.total)].join(';'));
  });
  return lines.join('\n');
}
function download(name, content){
  const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ---------------- UI ---------------- */
async function load(){
  setBadge('carregando...');
  try {
    const params = {};
    const f = el('from').value, t = el('to').value, g = el('grua').value;
    if (f) params.from = f;
    if (t) params.to = t;
    if (g) params.grua = g;
    const data = await jsonp(API_URL, params);
    window.__lastData = data; // guarda p/ CSV
    render(data);
  } catch (err) {
    setBadge('erro');
    statusEl.textContent = err.message || String(err);
  }
}

el('btnAtualizar').addEventListener('click', load);
el('btnCsv').addEventListener('click', ()=>{
  if (!window.__lastData || !window.__lastData.ok) return;
  const {meta} = window.__lastData;
  download(`detalhado_${meta.from}_a_${meta.to}.csv`, toCsv(window.__lastData));
});

// datas padrão: mês atual
(function initDates(){
  const now = new Date();
  const y = now.getFullYear(), m = now.getMonth();
  const pad = n=>String(n).padStart(2,'0');
  const first = `${y}-${pad(m+1)}-01`;
  const last = new Date(y, m+1, 0);
  const lastStr = `${y}-${pad(m+1)}-${pad(last.getDate())}`;
  el('from').value = first;
  el('to').value = lastStr;
})();

load();
</script>
</body>
</html>
