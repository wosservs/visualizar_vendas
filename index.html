<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DETALHADO GERAL – Dia a Dia</title>
<style>
  :root { --bg:#0e1116; --surface:#121722; --muted:#94a3b8; --txt:#e5e7eb; --accent:#ff8c1a; --danger: #dc2626; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
  .wrap{max-width:95%;margin:24px auto;padding:0 16px;}
  h1{font-size:22px;margin:0 0 16px;}
  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px;}
  .toolbar input,.toolbar select,.toolbar button{background:var(--surface);border:1px solid #374151;color:var(--txt);padding:8px 12px;border-radius:6px;font-size:14px;}
  .toolbar button{background:var(--accent);color:#000;border:0;font-weight:600;cursor:pointer;transition: opacity 0.2s;}
  .toolbar button:hover{opacity: 0.85;}
  .badge{font-size:12px;font-weight:600;color:#000;background:var(--accent);padding:4px 10px;border-radius:999px;margin-left:8px;vertical-align:middle;}
  .badge.error{background:var(--danger);color:white;}
  .tablewrap{background:var(--surface);border:1px solid #374151;border-radius:12px;overflow:auto;max-height: 70vh;}
  table{border-collapse:collapse;width:100%;}
  th,td{padding:10px 12px;border-bottom:1px solid #374151;white-space:nowrap;text-align:left;}
  th{position:sticky;top:0;background:#1f2937;font-weight:600;z-index:10;}
  th:first-child, td:first-child {position:sticky;left:0;background:#1f2937;width:150px;}
  td:first-child {background: var(--surface);}
  tr:hover td, tr:hover td:first-child {background:#2b3445;}
  .num{text-align:right;}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding: 0 5px;color:var(--muted);font-size:12px;}
  .status.error{color:var(--danger);font-weight:600;}
</style>
</head>
<body>
<div class="wrap">
  <h1>DETALHADO GERAL – Dia a Dia <span id="badge" class="badge"></span></h1>

  <div class="toolbar">
    <label>De: <input type="date" id="from"></label>
    <label>Até: <input type="date" id="to"></label>
    <label>Grua: 
      <select id="grua">
        <option value="">Todas</option>
      </select>
    </label>
    <button id="btnAtualizar">Atualizar</button>
    <button id="btnCsv">Exportar CSV</button>
  </div>

  <div class="tablewrap">
    <table id="tbl">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer">
    <div id="meta"></div>
    <div id="status" class="status"></div>
  </div>
</div>

<script>
const API_URL = '<?= ScriptApp.getService().getUrl() ?>';

// Função para buscar dados com JSONP
function jsonp(url, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    params.callback = cb;
    const qs = new URLSearchParams(params).toString();
    const script = document.createElement('script');
    const timeout = setTimeout(() => {
      cleanup();
      reject(new Error('Timeout: A requisição demorou mais de 30 segundos.'));
    }, 30000);

    function cleanup() {
      clearTimeout(timeout);
      script.remove();
      delete window[cb];
    }

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };
    script.onerror = () => {
      cleanup();
      reject(new Error('Erro de rede ou URL do Web App incorreta.'));
    };

    script.src = url + '?' + qs;
    document.head.appendChild(script);
  });
}

// Elementos da UI
const el = (id) => document.getElementById(id);
const ui = {
  badge: el('badge'), thead: el('thead'), tbody: el('tbody'),
  status: el('status'), meta: el('meta'), from: el('from'),
  to: el('to'), grua: el('grua'), btnAtualizar: el('btnAtualizar'),
  btnCsv: el('btnCsv')
};

function setStatus(text, isError = false) {
  ui.badge.textContent = text;
  ui.badge.className = isError ? 'badge error' : 'badge';
  ui.status.textContent = isError ? text : '';
  ui.status.className = isError ? 'status error' : 'status';
}

const fmt = (n) => (Number(n) || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const fmtDate = (iso) => iso.split('-').reverse().join('/');

function render(data) {
  const { dates, gruas, rows } = data;
  setStatus(`${rows.length} gruas · ${dates.length} dias`);
  ui.meta.textContent = dates.length ? `Período: ${fmtDate(dates[0])} a ${fmtDate(dates[dates.length - 1])}` : 'Nenhum período selecionado';

  const currentGrua = ui.grua.value;
  ui.grua.innerHTML = '<option value="">Todas</option>' + gruas.map(g => `<option value="${g}">${g}</option>`).join('');
  ui.grua.value = currentGrua;

  const headerCols = ['GRUA', 'LOCAL', 'TOTAL PERÍODO', ...dates.map(fmtDate)];
  ui.thead.innerHTML = `<tr>${headerCols.map((c, i) => `<th class="${i > 1 ? 'num' : ''}">${c}</th>`).join('')}</tr>`;

  ui.tbody.innerHTML = rows.map(r => {
    const cells = [
      `<td>${r.grua}</td>`,
      `<td>${r.local}</td>`,
      `<td class="num"><b>${fmt(r.totalPeriodo)}</b></td>`,
      ...r.values.map(v => `<td class="num">${v > 0 ? fmt(v) : ''}</td>`)
    ];
    return `<tr>${cells.join('')}</tr>`;
  }).join('');
}

async function loadData() {
  setStatus('Carregando...');
  ui.btnAtualizar.disabled = true;
  try {
    const params = { action: 'fetch' };
    if (ui.from.value) params.start = ui.from.value;
    if (ui.to.value) params.end = ui.to.value;
    if (ui.grua.value) params.grua = ui.grua.value;

    const data = await jsonp(API_URL, params);
    if (!data.ok) throw new Error(data.error || 'Erro desconhecido no servidor.');
    
    window.__lastData = data;
    render(data);
  } catch (err) {
    setStatus(err.message, true);
    console.error(err);
  } finally {
    ui.btnAtualizar.disabled = false;
  }
}

function exportCsv() {
  const data = window.__lastData;
  if (!data || !data.ok) {
    alert('Não há dados para exportar. Por favor, atualize primeiro.');
    return;
  }
  const { dates, rows } = data;
  const header = ['GRUA', 'LOCAL', 'REDE', ...dates].join(';');
  const lines = rows.map(r => 
    [r.grua, r.local, r.rede, ...r.values.map(v => fmt(v).replace(/\./g, '').replace(',', '.'))].join(';')
  );
  const csvContent = [header, ...lines].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `detalhado_${dates[0]}_a_${dates[dates.length-1]}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// Configuração Inicial
ui.btnAtualizar.addEventListener('click', loadData);
ui.btnCsv.addEventListener('click', exportCsv);

(function init() {
  const now = new Date();
  const y = now.getFullYear(), m = now.getMonth();
  const pad = n => String(n).padStart(2, '0');
  ui.from.value = `${y}-${pad(m + 1)}-01`;
  const lastDay = new Date(y, m + 1, 0).getDate();
  ui.to.value = `${y}-${pad(m + 1)}-${pad(lastDay)}`;
  
  loadData();
})();
</script>
</body>
</html>
